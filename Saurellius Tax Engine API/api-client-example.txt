// Example client SDK for Saurellius Tax Engine

class SaurelliusTaxClient {
  /**
   * Create a new Saurellius Tax Engine client
   * @param {string} apiKey - Your API key
   * @param {Object} options - Configuration options
   */
  constructor(apiKey, options = {}) {
    this.apiKey = apiKey;
    this.baseUrl = options.baseUrl || 'https://api.saurellius.com/v1';
    this.timeout = options.timeout || 30000; // 30 seconds default timeout
  }

  /**
   * Calculate taxes for an employee
   * @param {Object} employeeData - Employee and payroll data
   * @returns {Promise<Object>} Tax calculation results
   */
  async calculateTaxes(employeeData) {
    return this._makeRequest('POST', '/calculate', employeeData);
  }

  /**
   * Calculate taxes for multiple employees in a batch
   * @param {Object} batchData - Batch of employee data
   * @returns {Promise<Object>} Batch calculation results
   */
  async calculateBatchTaxes(batchData) {
    return this._makeRequest('POST', '/calculate/batch', batchData);
  }

  /**
   * Calculate taxes for an employee working in multiple states
   * @param {Object} multistateData - Employee data with multiple work locations
   * @returns {Promise<Object>} Multistate tax calculation results
   */
  async calculateMultistateTaxes(multistateData) {
    return this._makeRequest('POST', '/multistate/calculate', multistateData);
  }

  /**
   * Validate and enhance an address with tax jurisdiction information
   * @param {Object} address - Address to validate
   * @returns {Promise<Object>} Validated address with jurisdiction information
   */
  async validateLocation(address) {
    return this._makeRequest('POST', '/locations/validate', { address });
  }

  /**
   * Get information about a specific tax jurisdiction
   * @param {string} jurisdictionId - Jurisdiction ID
   * @returns {Promise<Object>} Jurisdiction information
   */
  async getJurisdiction(jurisdictionId) {
    return this._makeRequest('GET', `/jurisdictions/${jurisdictionId}`);
  }

  /**
   * Get tax rates for multiple jurisdictions
   * @param {Object} options - Query options
   * @returns {Promise<Object>} Tax rates
   */
  async getTaxRates(options = {}) {
    const queryParams = new URLSearchParams();
    
    if (options.jurisdictionIds) {
      queryParams.append('jurisdictionIds', options.jurisdictionIds.join(','));
    }
    
    if (options.taxTypes) {
      queryParams.append('taxTypes', options.taxTypes.join(','));
    }
    
    if (options.effectiveDate) {
      queryParams.append('effectiveDate', options.effectiveDate);
    }
    
    const url = `/taxes/rates?${queryParams.toString()}`;
    return this._makeRequest('GET', url);
  }

  /**
   * Calculate optimal withholding based on employee information
   * @param {Object} w4Data - Employee W-4 information
   * @returns {Promise<Object>} Withholding recommendations
   */
  async calculateW4(w4Data) {
    return this._makeRequest('POST', '/w4/calculate', w4Data);
  }

  /**
   * Get reciprocity rules between states
   * @param {string} homeState - Home state code
   * @param {string} workState - Work state code
   * @returns {Promise<Object>} Reciprocity information
   */
  async getReciprocityRules(homeState, workState) {
    const url = `/reciprocity/rules?homeState=${homeState}&workState=${workState}`;
    return this._makeRequest('GET', url);
  }

  /**
   * Get information about recent tax updates
   * @param {Object} options - Query options
   * @returns {Promise<Object>} Tax updates
   */
  async getTaxUpdates(options = {}) {
    const queryParams = new URLSearchParams();
    
    if (!options.since) {
      throw new Error('The "since" date parameter is required');
    }
    
    queryParams.append('since', options.since);
    
    if (options.jurisdictionIds) {
      queryParams.append('jurisdictionIds', options.jurisdictionIds.join(','));
    }
    
    if (options.taxTypes) {
      queryParams.append('taxTypes', options.taxTypes.join(','));
    }
    
    const url = `/taxes/updates?${queryParams.toString()}`;
    return this._makeRequest('GET', url);
  }

  /**
   * Create or update employee records
   * @param {Object} employeeData - Employee data to create or update
   * @returns {Promise<Object>} Result of the operation
   */
  async createOrUpdateEmployees(employeeData) {
    return this._makeRequest('POST', '/employees', employeeData);
  }

  /**
   * Register a webhook to receive tax update notifications
   * @param {Object} webhookData - Webhook registration data
   * @returns {Promise<Object>} Webhook registration result
   */
  async registerWebhook(webhookData) {
    return this._makeRequest('POST', '/webhooks', webhookData);
  }

  /**
   * Make an HTTP request to the Saurellius API
   * @param {string} method - HTTP method
   * @param {string} path - API endpoint path
   * @param {Object} data - Request data (for POST requests)
   * @returns {Promise<Object>} API response
   * @private
   */
  async _makeRequest(method, path, data = null) {
    const url = `${this.baseUrl}${path}`;
    
    const headers = {
      'Authorization': `ApiKey ${this.apiKey}`,
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'User-Agent': 'SaurelliusTaxClient/1.0.0'
    };
    
    const options = {
      method,
      headers,
      timeout: this.timeout
    };
    
    if (data && (method === 'POST' || method === 'PUT')) {
      options.body = JSON.stringify(data);
    }
    
    try {
      const response = await fetch(url, options);
      const responseData = await response.json();
      
      if (!response.ok) {
        throw new SaurelliusApiError(
          responseData.error.code || 'api_error',
          responseData.error.message || 'Unknown API error',
          responseData.error.details,
          response.status
        );
      }
      
      return responseData;
    } catch (error) {
      if (error instanceof SaurelliusApiError) {
        throw error;
      } else {
        throw new SaurelliusApiError(
          'network_error',
          `Network request failed: ${error.message}`,
          null,
          0
        );
      }
    }
  }
}

/**
 * Custom error class for Saurellius API errors
 */
class SaurelliusApiError extends Error {
  /**
   * Create a new Saurellius API error
   * @param {string} code - Error code
   * @param {string} message - Error message
   * @param {string|null} details - Detailed error information
   * @param {number} statusCode - HTTP status code
   */
  constructor(code, message, details = null, statusCode = 0) {
    super(message);
    this.name = 'SaurelliusApiError';
    this.code = code;
    this.details = details;
    this.statusCode = statusCode;
  }
}

// Example usage:
async function exampleUsage() {
  try {
    // Initialize the client
    const taxClient = new SaurelliusTaxClient('your_api_key_here');
    
    // Calculate taxes for an employee
    const taxResult = await taxClient.calculateTaxes({
      employee: {
        id: "EMP12345",
        firstName: "Jane",
        lastName: "Doe",
        ssn: "123-45-6789",
        homeAddress: {
          street1: "123 Home St",
          city: "Phoenix",
          state: "AZ",
          zipCode: "85001"
        },
        workAddress: {
          street1: "456 Office Blvd",
          city: "Phoenix",
          state: "AZ",
          zipCode: "85004"
        }
      },
      payPeriod: {
        startDate: "2025-03-01",
        endDate: "2025-03-15",
        payDate: "2025-03-20",
        periodType: "biweekly"
      },
      earnings: {
        regularEarnings: 2000.00,
        overtimeEarnings: 150.00
      },
      preTaxDeductions: {
        retirement401k: 100.00,
        medical: 50.00
      },
      federalWithholding: {
        filingStatus: "single",
        allowances: 1
      },
      stateWithholding: {
        filingStatus: "single",
        allowances: 1
      }
    });
    
    console.log('Tax Calculation Result:', taxResult);
    
    // Validate an address
    const locationResult = await taxClient.validateLocation({
      street1: "123 Main St",
      city: "Phoenix",
      state: "AZ",
      zipCode: "85001"
    });
    
    console.log('Location Validation Result:', locationResult);
    
    // Get tax rates
    const taxRatesResult = await taxClient.getTaxRates({
      jurisdictionIds: ['ST_AZ', 'CTY_AZ_MARICOPA'],
      effectiveDate: '2025-01-01'
    });
    
    console.log('Tax Rates Result:', taxRatesResult);
    
  } catch (error) {
    if (error instanceof SaurelliusApiError) {
      console.error(`API Error (${error.code}): ${error.message}`);
      if (error.details) {
        console.error('Details:', error.details);
      }
    } else {
      console.error('Unexpected error:', error);
    }
  }
}

// Export the client for use in Node.js or as a module
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { SaurelliusTaxClient, SaurelliusApiError };
}
